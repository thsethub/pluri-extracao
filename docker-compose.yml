version: "3.8"

services:
  # ── PostgreSQL ──────────────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    container_name: pluri-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${PG_USER:-pluri}
      POSTGRES_PASSWORD: ${PG_PASSWORD:-pluri123}
      POSTGRES_DB: ${PG_NAME:-pluri_assuntos}
    ports:
      - "${PG_PORT:-5434}:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PG_USER:-pluri}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── API de Classificação (FastAPI - porta 8000) ─────────────
  api:
    image: ghcr.io/thsethub/pluri-extracao/api:latest
    container_name: pluri-api
    restart: unless-stopped
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-3.5-turbo}
      - OPENAI_MAX_TOKENS=${OPENAI_MAX_TOKENS:-500}
      - OPENAI_TEMPERATURE=${OPENAI_TEMPERATURE:-0}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - MAX_RETRIES=${MAX_RETRIES:-3}
      - RETRY_DELAY=${RETRY_DELAY:-1}
      - DISCIPLINES=${DISCIPLINES:-Artes,Biologia,Ciências,Educação Física,Espanhol,Filosofia,Física,Geografia,História,Língua Inglesa,Língua Portuguesa,Matemática,Natureza e Sociedade,Química,Sociologia}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT:-3306}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME:-trieduc}
      - PG_HOST=postgres
      - PG_PORT=5432
      - PG_USER=${PG_USER:-pluri}
      - PG_PASSWORD=${PG_PASSWORD:-pluri123}
      - PG_NAME=${PG_NAME:-pluri_assuntos}
    ports:
      - "${API_PORT:-8989}:8000"
    volumes:
      - api-logs:/app/logs
      - api-data:/app/data
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/docs')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    labels:
      - "com.centurylinklabs.watchtower.scope=pluri"

  # ── Webscraping Agent (Painel Web - porta 8501) ─────────────
  webscraping:
    image: ghcr.io/thsethub/pluri-extracao/webscraping:latest
    container_name: pluri-webscraping
    restart: unless-stopped
    shm_size: "2gb"
    environment:
      - API_BASE_URL=http://api:8000
      - HEADLESS=true
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - SUPERPRO_EMAIL=${SUPERPRO_EMAIL}
      - SUPERPRO_PASSWORD=${SUPERPRO_PASSWORD}
    ports:
      - "${WS_PORT:-8501}:8501"
    volumes:
      - ws-logs:/app/logs
      - ws-storage:/app/storage
    depends_on:
      api:
        condition: service_healthy
    labels:
      - "com.centurylinklabs.watchtower.scope=pluri"

  # ── Classificacao Frontend (Porta 9595) ──────────────────────
  frontend:
    image: ghcr.io/thsethub/pluri-extracao/frontend:latest
    container_name: pluri-frontend
    restart: unless-stopped
    environment:
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:8989/classificacao}
    ports:
      - "9595:3000"
    depends_on:
      api:
        condition: service_healthy
    labels:
      - "com.centurylinklabs.watchtower.scope=pluri"

  # ── Watchtower (auto-update das imagens) ────────────────────
  watchtower:
    image: containrrr/watchtower
    container_name: pluri-watchtower
    restart: unless-stopped
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=300
      - WATCHTOWER_LABEL_ENABLE=false
      - WATCHTOWER_SCOPE=pluri
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: --scope pluri --interval 300
    labels:
      - "com.centurylinklabs.watchtower.scope=pluri"

volumes:
  pgdata:
  api-logs:
  api-data:
  ws-logs:
  ws-storage:
